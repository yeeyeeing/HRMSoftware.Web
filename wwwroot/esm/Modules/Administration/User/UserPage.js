import{a as T}from"../../../_chunks/chunk-VDMXQNXQ.js";import{a as E}from"../../../_chunks/chunk-NYW6PQJD.js";import{h as x,j as O,k as S,l as U,m as i,n as R}from"../../../_chunks/chunk-DA7Z2NN7.js";import"../../../_chunks/chunk-27W64ILM.js";import"../../../_chunks/chunk-NN5FEWI3.js";import"../../../_chunks/chunk-KCWQ5BXW.js";import"../../../_chunks/chunk-MVZ476J5.js";import"../../../_chunks/chunk-DMDSRNFC.js";import"../../../_chunks/chunk-LLMDZJQJ.js";import{b as g}from"../../../_chunks/chunk-MUCPV7IN.js";import"../../../_chunks/chunk-K2UT2MVJ.js";import{a as D}from"../../../_chunks/chunk-DNINIZJD.js";import{c as n,g as s,h as I,k as f}from"../../../_chunks/chunk-L3ECGIWB.js";var B=s(f(),1);var C=s(D(),1),v=s(f(),1);var c=s(D(),1),p=s(f(),1);var k=s(D(),1),o=s(f(),1);var h=class extends k.TemplatedDialog{constructor(t){super(t);this.permissions=new T(this.byId("Permissions"),{showRevoke:!0}),U.List({UserID:this.options.userID,Module:null,Submodule:null},e=>{this.permissions.value=e.Entities}),U.ListRolePermissions({UserID:this.options.userID,Module:null,Submodule:null},e=>{this.permissions.rolePermissions=e.Entities}),this.permissions.implicitPermissions=(0,o.getRemoteData)("Administration.ImplicitPermissions"),this.dialogTitle=(0,o.format)((0,o.localText)("Site.UserPermissionDialog.DialogTitle"),this.options.username)}getDialogButtons(){return[{text:(0,o.localText)("Dialogs.OkButton"),cssClass:"btn btn-primary",click:t=>{U.Update({UserID:this.options.userID,Permissions:this.permissions.value,Module:null,Submodule:null},e=>{this.dialogClose(),window.setTimeout(()=>(0,o.notifySuccess)((0,o.localText)("Site.UserPermissionDialog.SaveSuccess")),0)})}},{text:(0,o.localText)("Dialogs.CancelButton"),click:()=>this.dialogClose()}]}getTemplate(){return'<div id="~_Permissions"></div>'}};n(h,"UserPermissionDialog");var N=s(D(),1);var w=s(f(),1);var u=class extends c.EntityDialog{constructor(){super();this.form=new S(this.idPrefix);this.form.Password.element.attr("autocomplete","new-password"),this.form.Password.change(()=>{c.EditorUtils.setRequired(this.form.PasswordConfirm,this.form.Password.value.length>0)}),this.form.Password.addValidationRule(this.uniqueName,t=>{if(this.form.Password.value.length<6)return(0,p.format)((0,p.localText)(E.Validation.MinRequiredPasswordLength),6)}),this.form.PasswordConfirm.addValidationRule(this.uniqueName,t=>{if(this.form.Password.value!=this.form.PasswordConfirm.value)return(0,p.localText)(E.Validation.PasswordConfirmMismatch)})}getFormKey(){return S.formKey}getIdProperty(){return i.idProperty}getIsActiveProperty(){return i.isActiveProperty}getLocalTextPrefix(){return i.localTextPrefix}getNameProperty(){return i.nameProperty}getService(){return R.baseUrl}getToolbarButtons(){let t=super.getToolbarButtons();return t.push({title:(0,p.localText)(E.Site.UserDialog.EditPermissionsButton),cssClass:"edit-permissions-button",icon:"fa-lock text-green",onClick:()=>{new h({userID:this.entity.UserId,username:this.entity.Username}).dialogOpen()}}),t}updateInterface(){super.updateInterface(),this.toolbar.findButton("edit-permissions-button").toggleClass("disabled",this.isNewOrDeleted())}dialogOpen(t){super.dialogOpen(t);var e=this;e.originalOwner=e.form.EmployeeRowID.value;var a=e.form.EmployeeRowID.value,r=document.getElementById(this.idPrefix+"EmployeeRowID");let y=new N.Select2Editor($(r));g.List({},m=>{for(var P in m.Entities)(m.Entities[P].CreateUser==!1||m.Entities[P].Id==a)&&y.addItem({id:m.Entities[P].Id.toString(),text:m.Entities[P].EmployeeID.toString()});(0,w.isEmptyOrNull)(a)||$(r).val(a.toString()).trigger("change")})}afterLoadEntity(){super.afterLoadEntity(),this.form.Password.element.toggleClass("required",this.isNew()).closest(".field").find("sup").toggle(this.isNew()),this.form.PasswordConfirm.element.toggleClass("required",this.isNew()).closest(".field").find("sup").toggle(this.isNew())}save_submitHandler(t){var e=this;super.save_submitHandler(t)}onSaveSuccess(t){var e=this;(0,w.isEmptyOrNull)(this.form.EmployeeRowID.value)||g.Update({EntityId:this.form.EmployeeRowID.value,Entity:{UserRowID:e.entityId,UserName:e.form.Username.value,CreateUser:!0,UserPassword:e.form.Password.value}}),e.form.EmployeeRowID.value!=e.originalOwner&&!(0,w.isEmptyOrNull)(e.originalOwner)&&g.Update({EntityId:e.originalOwner,Entity:{UserRowID:null,UserName:null,CreateUser:!1,UserPassword:null}}),super.onSaveSuccess(t)}onDeleteSuccess(t){(0,w.isEmptyOrNull)(this.originalOwner)||g.Update({EntityId:this.originalOwner,Entity:{UserRowID:null,UserName:null,CreateUser:!1,UserPassword:null}}),super.onDeleteSuccess(t)}};n(u,"UserDialog"),u=I([c.Decorators.registerClass()],u);var d=class extends C.EntityGrid{getColumnsKey(){return O.columnsKey}getDialogType(){return u}getIdProperty(){return i.idProperty}getIsActiveProperty(){return i.isActiveProperty}getLocalTextPrefix(){return i.localTextPrefix}getService(){return R.baseUrl}constructor(l){super(l)}getDefaultSortBy(){return[i.Fields.Username]}getColumns(){var l=super.getColumns(),t=(0,v.tryFirst)(l,r=>r.field=="ImpersonationToken");t!=null&&(t.format=r=>r.value?`<a target="_blank" href="${(0,v.resolveUrl)("~/Account/ImpersonateAs?token=")}${r.value}"><i class="fa fa-user-secret text-blue"></i></a>`:"");var e=(0,v.tryFirst)(l,r=>r.field==i.Fields.Roles);if(e){var a;x.getLookupAsync().then(r=>{a=r,this.slickGrid.invalidate()}),e.format=r=>{if(!a)return'<i class="fa fa-spinner"></i>';var y=(r.value||[]).map(m=>(a.itemById[m]||{}).RoleName||"");return y.sort(),y.join(", ")}}return l}};n(d,"UserGrid"),d=I([C.Decorators.registerClass()],d);function L(){(0,B.initFullHeightGridPage)(new d($("#GridDiv")).element)}n(L,"pageInit");export{L as default};
//# sourceMappingURL=UserPage.js.map
