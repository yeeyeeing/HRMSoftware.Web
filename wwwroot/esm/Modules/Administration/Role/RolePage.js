import{a as O}from"../../../_chunks/chunk-MXCAVYUW.js";import{e as _,f as x,g as T,h as P,i as y}from"../../../_chunks/chunk-3FMYFY2A.js";import"../../../_chunks/chunk-OAOSE5IN.js";import{a as D}from"../../../_chunks/chunk-DNINIZJD.js";import{c,g as p,h as v,k as S}from"../../../_chunks/chunk-L3ECGIWB.js";var A=p(S(),1);var b=p(D(),1);var w=p(D(),1);var U=p(D(),1),m=p(S(),1);var l=p(D(),1),n=p(S(),1);var h=class extends l.DataGrid{constructor(e,t){super(e,t);this._rolePermissions={};this._implicitPermissions={};let i={};this.getSortedGroupAndPermissionKeys(i,s=>{if(!this.element)return;let o=s.map(a=>({Key:a,ParentKey:this.getParentKey(a),Title:i[a],GrantRevoke:null,IsGroup:a.charAt(a.length-1)===":"}));this.byParentKey=(0,n.toGrouping)(o,a=>a.ParentKey),this.setItems(o),this.value=this._value})}getIdProperty(){return"Key"}getItemGrantRevokeClass(e,t){if(!e.IsGroup)return e.GrantRevoke===t?" checked":"";let i=this.getDescendants(e,!0),s=i.filter(o=>o.GrantRevoke===t);return s.length?i.length===s.length?"checked":"checked partial":""}roleOrImplicit(e){if(this._rolePermissions[e])return!0;for(var t of Object.keys(this._rolePermissions)){var i=this._implicitPermissions[t];if(i&&i[e])return!0}for(var s of Object.keys(this._implicitPermissions)){var o=this.view.getItemById(s);if(o&&o.GrantRevoke==!0){var i=this._implicitPermissions[s];if(i&&i[e])return!0}}}getItemEffectiveClass(e){if(e.IsGroup){let i=this.getDescendants(e,!0),s=(0,n.count)(i,o=>o.GrantRevoke===!0||o.GrantRevoke==null&&this.roleOrImplicit(o.Key));return s===i.length||i.length===0?"allow":s===0?"deny":"partial"}return e.GrantRevoke===!0||e.GrantRevoke==null&&this.roleOrImplicit(e.Key)?" allow":" deny"}getColumns(){let e=[{name:(0,n.localText)("Site.UserPermissionDialog.Permission"),field:"Title",format:l.SlickFormatting.treeToggle(()=>this.view,t=>t.Key,t=>{let i=t.item;return'<span class="effective-permission '+this.getItemEffectiveClass(i)+'">'+(0,n.htmlEncode)(t.value)+"</span>"}),width:495,sortable:!1},{name:(0,n.localText)("Site.UserPermissionDialog.Grant"),field:"Grant",format:t=>{let i=t.item;return"<span class='check-box grant no-float "+this.getItemGrantRevokeClass(i,!0)+"'></span>"},width:65,sortable:!1,headerCssClass:"align-center",cssClass:"align-center"}];return this.options.showRevoke&&e.push({name:(0,n.localText)("Site.UserPermissionDialog.Revoke"),field:"Revoke",format:t=>{let i=t.item;return'<span class="check-box revoke no-float '+this.getItemGrantRevokeClass(i,!1)+'"></span>'},width:65,sortable:!1,headerCssClass:"align-center",cssClass:"align-center"}),e}setItems(e){l.SlickTreeHelper.setIndents(e,t=>t.Key,t=>t.ParentKey,!1),this.view.setItems(e,!0)}onViewSubmit(){return!1}onViewFilter(e){return!super.onViewFilter(e)||!l.SlickTreeHelper.filterById(e,this.view,t=>t.ParentKey)?!1:this.searchText?this.matchContains(e)||e.IsGroup&&(0,n.any)(this.getDescendants(e,!1),t=>this.matchContains(t)):!0}matchContains(e){return Select2.util.stripDiacritics(e.Title||"").toLowerCase().indexOf(this.searchText)>=0}getDescendants(e,t){let i=[],s=[e];for(;s.length>0;){let o=s.pop(),a=this.byParentKey[o.Key];if(a)for(let r of a)(!t||!r.IsGroup)&&i.push(r),s.push(r)}return i}onClick(e,t,i){if(super.onClick(e,t,i),e.isDefaultPrevented()||l.SlickTreeHelper.toggleClick(e,t,i,this.view,r=>r.Key),e.isDefaultPrevented())return;let s=$(e.target),o=s.hasClass("grant");if(o||s.hasClass("revoke")){e.preventDefault();let r=this.itemAt(t),u=s.hasClass("checked")||s.hasClass("partial");if(u?o=null:o=o!==u,r.IsGroup)for(var a of this.getDescendants(r,!0))a.GrantRevoke=o;else r.GrantRevoke=o;this.slickGrid.invalidate()}}getParentKey(e){e.charAt(e.length-1)===":"&&(e=e.substr(0,e.length-1));let t=e.lastIndexOf(":");return t>=0?e.substr(0,t+1):null}getButtons(){return[]}createToolbarExtensions(){super.createToolbarExtensions(),l.GridUtils.addQuickSearchInputCustom(this.toolbar.element,(e,t)=>{this.searchText=Select2.util.stripDiacritics((0,n.trimToNull)(t)||"").toLowerCase(),this.view.setItems(this.view.getItems(),!0)})}getSortedGroupAndPermissionKeys(e,t){(0,n.getRemoteDataAsync)("Administration.PermissionKeys").then(i=>{var a;let s={};for(var o of i){let r=o;if(!r||r.charAt(r.length-1)==":"&&(r=r.substring(0,r.length-1),r.length===0)||e[r])continue;e[r]=(a=(0,n.tryGetText)("Permission."+r))!=null?a:r;let u=r.split(":"),d="",C="";for(let k=0;k<u.length-1;k++){d=d+u[k]+":";let K=(0,n.tryGetText)("Permission."+d);K==null&&(K=u[k]),e[d]=K,C=C+e[d]+":",s[d]=C}s[r]=C+e[r]}i=Object.keys(e),i=i.sort((r,u)=>(0,n.turkishLocaleCompare)(s[r],s[u])),t(i)})}get value(){let e=[];if(!this.view.getItems().length)return(this._value||[]).map(t=>({PermissionKey:t.PermissionKey,Granted:t.Granted}));for(let t of this.view.getItems())t.GrantRevoke!=null&&t.Key.charAt(t.Key.length-1)!=":"&&e.push({PermissionKey:t.Key,Granted:t.GrantRevoke});return e}set value(e){var t;this._value=e;for(let i of this.view.getItems())i.GrantRevoke=null;if(e!=null)for(let i of e){let s=this.view.getItemById(i.PermissionKey);s&&(s.GrantRevoke=(t=i.Granted)!=null?t:!0)}this.setItems(this.getItems())}get rolePermissions(){return Object.keys(this._rolePermissions)}set rolePermissions(e){if(this._rolePermissions={},e)for(let t of e)this._rolePermissions[t]=!0;this.setItems(this.getItems())}set implicitPermissions(e){if(this._implicitPermissions={},e)for(var t of Object.keys(e)){this._implicitPermissions[t]=this._implicitPermissions[t]||{};var i=e[t];if(i)for(var s of i)this._implicitPermissions[t][s]=!0}}};c(h,"PermissionCheckEditor"),h=v([l.Decorators.registerEditor("HRMSoftware.Administration.PermissionCheckEditor",[l.IGetEditValue,l.ISetEditValue])],h);var I=class extends U.TemplatedDialog{constructor(e){super(e);this.permissions=new h(this.byId("Permissions"),{showRevoke:!1}),T.List({RoleID:this.options.roleID,Module:null,Submodule:null},t=>{this.permissions.value=t.Entities.map(i=>({PermissionKey:i}))}),this.permissions.implicitPermissions=(0,m.getRemoteData)("Administration.ImplicitPermissions")}getDialogOptions(){let e=super.getDialogOptions();return e.buttons=[{text:(0,m.localText)("Dialogs.OkButton"),click:t=>{T.Update({RoleID:this.options.roleID,Permissions:this.permissions.value.map(i=>i.PermissionKey),Module:null,Submodule:null},i=>{this.dialogClose(),window.setTimeout(()=>(0,m.notifySuccess)((0,m.localText)("Site.RolePermissionDialog.SaveSuccess")),0)})}},{text:(0,m.localText)("Dialogs.CancelButton"),click:()=>this.dialogClose()}],e.title=(0,m.format)((0,m.localText)("Site.RolePermissionDialog.DialogTitle"),this.options.title),e}getTemplate(){return'<div id="~_Permissions"></div>'}};c(I,"RolePermissionDialog");var E="edit-permissions",f=class extends w.EntityDialog{constructor(){super(...arguments);this.form=new x(this.idPrefix)}getFormKey(){return x.formKey}getRowDefinition(){return P}getService(){return y.baseUrl}getToolbarButtons(){let e=super.getToolbarButtons();return e.push({title:O.Site.RolePermissionDialog.EditButton,cssClass:E,icon:"fa-lock text-green",onClick:()=>{new I({roleID:this.entity.RoleId,title:this.entity.RoleName}).dialogOpen()}}),e}updateInterface(){super.updateInterface(),this.toolbar.findButton(E).toggleClass("disabled",this.isNewOrDeleted())}};c(f,"RoleDialog"),f=v([w.Decorators.registerClass("HRMSoftware.Administration.RoleDialog")],f);var g=class extends b.EntityGrid{getColumnsKey(){return _.columnsKey}getDialogType(){return f}getRowDefinition(){return P}getService(){return y.baseUrl}constructor(R){super(R)}getDefaultSortBy(){return[P.Fields.RoleName]}};c(g,"RoleGrid"),g=v([b.Decorators.registerClass("HRMSoftware.Administration.RoleGrid")],g);function B(){(0,A.initFullHeightGridPage)(new g($("#GridDiv")).element)}c(B,"pageInit");export{B as default};
//# sourceMappingURL=RolePage.js.map
