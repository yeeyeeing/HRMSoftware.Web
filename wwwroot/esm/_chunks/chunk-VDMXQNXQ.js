import{a as P}from"./chunk-DNINIZJD.js";import{c as g,g as v,h as d,k as I}from"./chunk-L3ECGIWB.js";var a=v(P(),1),o=v(I(),1);var c=class extends a.DataGrid{constructor(e,t){super(e,t);this._rolePermissions={};this._implicitPermissions={};let i={};this.getSortedGroupAndPermissionKeys(i,s=>{if(!this.element)return;let n=s.map(l=>({Key:l,ParentKey:this.getParentKey(l),Title:i[l],GrantRevoke:null,IsGroup:l.charAt(l.length-1)===":"}));this.byParentKey=(0,o.toGrouping)(n,l=>l.ParentKey),this.setItems(n),this.value=this._value})}getIdProperty(){return"Key"}getItemGrantRevokeClass(e,t){if(!e.IsGroup)return e.GrantRevoke===t?" checked":"";let i=this.getDescendants(e,!0),s=i.filter(n=>n.GrantRevoke===t);return s.length?i.length===s.length?"checked":"checked partial":""}roleOrImplicit(e){if(this._rolePermissions[e])return!0;for(var t of Object.keys(this._rolePermissions)){var i=this._implicitPermissions[t];if(i&&i[e])return!0}for(var s of Object.keys(this._implicitPermissions)){var n=this.view.getItemById(s);if(n&&n.GrantRevoke==!0){var i=this._implicitPermissions[s];if(i&&i[e])return!0}}}getItemEffectiveClass(e){if(e.IsGroup){let i=this.getDescendants(e,!0),s=(0,o.count)(i,n=>n.GrantRevoke===!0||n.GrantRevoke==null&&this.roleOrImplicit(n.Key));return s===i.length||i.length===0?"allow":s===0?"deny":"partial"}return e.GrantRevoke===!0||e.GrantRevoke==null&&this.roleOrImplicit(e.Key)?" allow":" deny"}getColumns(){let e=[{name:(0,o.localText)("Site.UserPermissionDialog.Permission"),field:"Title",format:a.SlickFormatting.treeToggle(()=>this.view,t=>t.Key,t=>{let i=t.item;return'<span class="effective-permission '+this.getItemEffectiveClass(i)+'">'+(0,o.htmlEncode)(t.value)+"</span>"}),width:495,sortable:!1},{name:(0,o.localText)("Site.UserPermissionDialog.Grant"),field:"Grant",format:t=>{let i=t.item;return"<span class='check-box grant no-float "+this.getItemGrantRevokeClass(i,!0)+"'></span>"},width:65,sortable:!1,headerCssClass:"align-center",cssClass:"align-center"}];return this.options.showRevoke&&e.push({name:(0,o.localText)("Site.UserPermissionDialog.Revoke"),field:"Revoke",format:t=>{let i=t.item;return'<span class="check-box revoke no-float '+this.getItemGrantRevokeClass(i,!1)+'"></span>'},width:65,sortable:!1,headerCssClass:"align-center",cssClass:"align-center"}),e}setItems(e){a.SlickTreeHelper.setIndents(e,t=>t.Key,t=>t.ParentKey,!1),this.view.setItems(e,!0)}onViewSubmit(){return!1}onViewFilter(e){return!super.onViewFilter(e)||!a.SlickTreeHelper.filterById(e,this.view,t=>t.ParentKey)?!1:this.searchText?this.matchContains(e)||e.IsGroup&&(0,o.any)(this.getDescendants(e,!1),t=>this.matchContains(t)):!0}matchContains(e){return Select2.util.stripDiacritics(e.Title||"").toLowerCase().indexOf(this.searchText)>=0}getDescendants(e,t){let i=[],s=[e];for(;s.length>0;){let n=s.pop(),l=this.byParentKey[n.Key];if(l)for(let r of l)(!t||!r.IsGroup)&&i.push(r),s.push(r)}return i}onClick(e,t,i){if(super.onClick(e,t,i),e.isDefaultPrevented()||a.SlickTreeHelper.toggleClick(e,t,i,this.view,r=>r.Key),e.isDefaultPrevented())return;let s=$(e.target),n=s.hasClass("grant");if(n||s.hasClass("revoke")){e.preventDefault();let r=this.itemAt(t),m=s.hasClass("checked")||s.hasClass("partial");if(m?n=null:n=n!==m,r.IsGroup)for(var l of this.getDescendants(r,!0))l.GrantRevoke=n;else r.GrantRevoke=n;this.slickGrid.invalidate()}}getParentKey(e){e.charAt(e.length-1)===":"&&(e=e.substr(0,e.length-1));let t=e.lastIndexOf(":");return t>=0?e.substr(0,t+1):null}getButtons(){return[]}createToolbarExtensions(){super.createToolbarExtensions(),a.GridUtils.addQuickSearchInputCustom(this.toolbar.element,(e,t)=>{this.searchText=Select2.util.stripDiacritics((0,o.trimToNull)(t)||"").toLowerCase(),this.view.setItems(this.view.getItems(),!0)})}getSortedGroupAndPermissionKeys(e,t){(0,o.getRemoteDataAsync)("Administration.PermissionKeys").then(i=>{var l;let s={};for(var n of i){let r=n;if(!r||r.charAt(r.length-1)==":"&&(r=r.substring(0,r.length-1),r.length===0)||e[r])continue;e[r]=(l=(0,o.tryGetText)("Permission."+r))!=null?l:r;let m=r.split(":"),h="",u="";for(let f=0;f<m.length-1;f++){h=h+m[f]+":";let p=(0,o.tryGetText)("Permission."+h);p==null&&(p=m[f]),e[h]=p,u=u+e[h]+":",s[h]=u}s[r]=u+e[r]}i=Object.keys(e),i=i.sort((r,m)=>(0,o.turkishLocaleCompare)(s[r],s[m])),t(i)})}get value(){let e=[];if(!this.view.getItems().length)return(this._value||[]).map(t=>({PermissionKey:t.PermissionKey,Granted:t.Granted}));for(let t of this.view.getItems())t.GrantRevoke!=null&&t.Key.charAt(t.Key.length-1)!=":"&&e.push({PermissionKey:t.Key,Granted:t.GrantRevoke});return e}set value(e){var t;this._value=e;for(let i of this.view.getItems())i.GrantRevoke=null;if(e!=null)for(let i of e){let s=this.view.getItemById(i.PermissionKey);s&&(s.GrantRevoke=(t=i.Granted)!=null?t:!0)}this.setItems(this.getItems())}get rolePermissions(){return Object.keys(this._rolePermissions)}set rolePermissions(e){if(this._rolePermissions={},e)for(let t of e)this._rolePermissions[t]=!0;this.setItems(this.getItems())}set implicitPermissions(e){if(this._implicitPermissions={},e)for(var t of Object.keys(e)){this._implicitPermissions[t]=this._implicitPermissions[t]||{};var i=e[t];if(i)for(var s of i)this._implicitPermissions[t][s]=!0}}};g(c,"PermissionCheckEditor"),c=d([a.Decorators.registerEditor("HRMSoftware.Administration.PermissionCheckEditor",[a.IGetEditValue,a.ISetEditValue])],c);export{c as a};
//# sourceMappingURL=chunk-VDMXQNXQ.js.map
